# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name		    openafs-client
version		    1.8.6
categories	    sysutils
license		    IPL-1
maintainers	    mit.edu:sipb-macathena
description	    AFS distributed fileystem client
long_description    AFS is a distributed filesystem allowing cross-platform \
		    sharing of files among multiple computers.  Facilities \
		    are provided for access control, authentication, backup \
		    and administrative management.
homepage	    http://www.openafs.org/
master_sites	    http://openafs.org/dl/openafs/${version}/
distname	    openafs-${version}-src

checksums           openafs-1.8.6-src.tar.gz \
                    rmd160  4a59624b935f25c9819902dfd38ee54d66b2a8d6 \
                    sha256  9efc374ef32b90ed62e59280535babff684d1bb551889d08abbf3e9d93e2e7d2 \
                    size    17789990 \
                    Auristor-client-0.195-Mojave.dmg \
                    rmd160  403ca9683d6a541e0eff8b79f7b82ea0f2afef88 \
                    sha256  9b0ff041d5158ab63b95e2520a01c81a9e6535f06955ff1e0c18a0b635b4f553 \
                    size    8651568

universal_variant   no

worksrcdir openafs-${version}

use_parallel_build  no

# Allow xcodebuild for the prefpane
use_xcode           yes

depends_build       port:swig-perl

patchfiles          swig-com_err.patch \
                    afsd_fuse.patch \
                    xcodebuild.patch
patch.args          -p1

if {${os.major} >= 13} {
    set use_signed_kext    yes
} else {
    set use_signed_kext    no
}

if { $use_signed_kext } {
    set mp.dist {
	13 9 Mavericks
	14 10 Yosemite
	15 11 ElCapitan
	16 12 Sierra
	17 13 HighSierra
	18 14 Mojave
	19 15 Catalina
    }
    foreach { mp.darwin mp.os mp.name } ${mp.dist} {
        if {${os.major} == ${mp.darwin}} {
            configure.args-append --disable-kernel-module
            # https://www.auristor.com/downloads/auristor/osx/macos-10.14/Auristor-client-0.195-Mojave.dmg
            master_sites-append https://www.auristor.com/downloads/auristor/osx/macos-10.${mp.os}:auristor
            distfiles-append Auristor-client-0.195-${mp.name}.dmg:auristor
            use_dmg yes
            extract.only Auristor-client-0.195-${mp.name}.dmg
        }
    }
}

post-extract {
    if { $use_signed_kext } {
	system -W ${workpath} "tar -xvf ${distpath}/openafs-${version}-src.tar.gz"
    }
}

destroot.target install dest
